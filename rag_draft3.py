# -*- coding: utf-8 -*-
"""RAG_Draft3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1f8o4LV-VFXy_BoeuCxwn-YVT4tUxJWLN
"""

# ==========================================
# BEAST v3 ‚Äî BULLETPROOF MEDICAL ASSISTANT
# MedQuAD + FULL consumer + Reproductive + Semen
# Condition Engine + Generic Medical Engine
# Bilingual + Comprehensive + No Missing Solutions
# ==========================================

!pip -q install sentence-transformers langdetect googletrans==4.0.0-rc1 ipywidgets

import pandas as pd, numpy as np, os, zipfile, requests, re, xml.etree.ElementTree as ET
from sentence_transformers import SentenceTransformer
from sklearn.metrics.pairwise import cosine_similarity
from langdetect import detect
from googletrans import Translator
import ipywidgets as widgets
from IPython.display import display, clear_output

# ======================
# LOAD MEDQUAD
# ======================
zip_url="https://github.com/abachaa/MedQuAD/archive/refs/heads/master.zip"
open("MedQuAD.zip","wb").write(requests.get(zip_url).content)

with zipfile.ZipFile("MedQuAD.zip","r") as z:
    z.extractall(".")

mq_q,mq_a=[],[]
for root,_,files in os.walk("MedQuAD-master"):
    for f in files:
        if f.endswith(".xml"):
            tree=ET.parse(os.path.join(root,f))
            rxml=tree.getroot()
            for qa in rxml.findall(".//QAPair"):
                q=qa.findtext("Question")
                a=qa.findtext("Answer")
                if q and a:
                    mq_q.append(q)
                    mq_a.append(a)

medquad_df=pd.DataFrame({"question":mq_q,"answer":mq_a})

# ======================
# FULL CONSUMER + REPRODUCTIVE + SEMEN DATA
# ======================
consumer_data = [

# GENERAL
("fever","Fever occurs when the body fights infection."),
("fatigue","Fatigue occurs due to stress or illness."),
("body ache","Body aches occur with viral infection."),
("weakness","Weakness may occur due to dehydration or illness."),

# HEAD
("headache","Headache due to tension or dehydration."),
("head hurts","Head pain due to tension."),
("pain in head","Headache symptom."),

# RESP
("cough","Cough due to airway irritation."),
("cold","Cold viral infection."),
("sinus pain","Sinus inflammation."),

# DIGESTIVE
("gas","Gas causes bloating."),
("bloating","Gas accumulation."),
("acidity","Acid reflux."),
("stomach pain","Indigestion."),

# MUSCLE
("back pain","Back strain."),

# WOMEN
("vaginal discharge","Discharge infection or hormonal."),
("vaginal smell","Odor due to imbalance."),
("vaginal itching","Fungal irritation."),
("period cramps","Menstrual cramps."),

# URINARY
("burning urination","UTI symptom"),

# SEMEN COLOR / CONSISTENCY
("blood in semen","Blood in semen inflammation."),
("reddish semen","Blood mixed semen."),
("pink semen","Minor bleeding semen."),
("brown semen","Old blood semen."),
("blood in sperm","Prostate inflammation."),
("rust semen","Old blood."),
("semen color change","Blood presence."),
("runny semen","Low sperm."),
("watery semen","Thin semen."),
("thin semen","Low density sperm."),
("sperm watery","Low concentration.")
]

cons_df=pd.DataFrame(consumer_data,columns=["question","answer"])

# ======================
# MERGE KB
# ======================
df=pd.concat([medquad_df,cons_df],ignore_index=True)

# ======================
# EMBEDDINGS
# ======================
model=SentenceTransformer("all-MiniLM-L6-v2")
embeddings=model.encode(df["question"].tolist(),show_progress_bar=True)

# ======================
# TRANSLATION
# ======================
translator=Translator()

def detect_lang(q):
    try: return detect(q)
    except: return "en"

def to_en(q):
    if detect_lang(q)=="hi":
        return translator.translate(q,src="hi",dest="en").text
    return q

def to_hi(t):
    return translator.translate(t,src="en",dest="hi").text

# ======================
# CONDITION DETECTOR
# ======================
def detect_condition(q):
    q=q.lower()

    if any(w in q for w in ["semen","sperm","ejaculate"]) and \
       any(w in q for w in ["red","reddish","pink","brown","blood","rust"]):
        return "blood_semen"

    if any(w in q for w in ["semen","sperm"]) and \
       any(w in q for w in ["runny","watery","thin"]):
        return "watery_semen"

    if "vaginal" in q and any(w in q for w in ["smell","odor"]):
        return "vaginal_discharge_odor"

    if "vaginal" in q and "itch" in q:
        return "vaginal_itching"

    if any(w in q for w in ["burning urination","burn urine"]):
        return "uti"

    if any(w in q for w in ["headache","head hurts","head pain","pain in head"]):
        return "headache"

    if "sinus" in q:
        return "sinusitis"

    if any(w in q for w in ["gas","bloating","acidity"]):
        return "gastritis"

    if "back pain" in q:
        return "back_pain"

    if "period" in q and any(w in q for w in ["cramp","pain"]):
        return "period_cramps"

    return None

# ======================
# SOLUTIONS LIBRARY
# ======================
solutions={

"headache":{
"summary_en":"Headache usually occurs due to tension, dehydration, or fatigue.",
"summary_hi":"‡§∏‡§ø‡§∞‡§¶‡§∞‡•ç‡§¶ ‡§Ö‡§ï‡•ç‡§∏‡§∞ ‡§§‡§®‡§æ‡§µ, ‡§™‡§æ‡§®‡•Ä ‡§ï‡•Ä ‡§ï‡§Æ‡•Ä ‡§Ø‡§æ ‡§•‡§ï‡§æ‡§® ‡§∏‡•á ‡§π‡•ã‡§§‡§æ ‡§π‡•à„ÄÇ",
"details_en":["Tension headache most common","Dehydration trigger","Screen strain factor"],
"details_hi":["‡§ü‡•á‡§Ç‡§∂‡§® ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø","‡§™‡§æ‡§®‡•Ä ‡§ï‡§Æ‡•Ä","‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡§æ‡§∞‡§£"],
"care_en":["Drink water","Rest","Reduce screen","Pain relief if needed"],
"care_hi":["‡§™‡§æ‡§®‡•Ä","‡§Ü‡§∞‡§æ‡§Æ","‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡§Æ","‡§¶‡§µ‡§æ"]
},

"blood_semen":{
"summary_en":"Blood in semen is usually due to prostate or seminal inflammation.",
"summary_hi":"‡§µ‡•Ä‡§∞‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§ñ‡•Ç‡§® ‡§™‡•ç‡§∞‡•ã‡§∏‡•ç‡§ü‡•á‡§ü ‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§Ç‡§•‡§ø ‡§∏‡•Ç‡§ú‡§® ‡§∏‡•á ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§",
"details_en":["Often benign","May follow activity","Resolves often"],
"details_hi":["‡§Ö‡§ï‡•ç‡§∏‡§∞ ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§®‡§π‡•Ä‡§Ç","‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø ‡§¨‡§æ‡§¶","‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§†‡•Ä‡§ï"],
"care_en":["Hydrate","Reduce ejaculation","Hygiene","Urologist if recurrent"],
"care_hi":["‡§™‡§æ‡§®‡•Ä","‡§Ü‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§ï‡§Æ","‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ‡§§‡§æ","‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞ ‡§π‡•ã ‡§§‡•ã ‡§°‡•â‡§ï‡•ç‡§ü‡§∞"]
},

"watery_semen":{
"summary_en":"Watery semen may indicate low sperm concentration.",
"summary_hi":"‡§™‡§§‡§≤‡§æ ‡§µ‡•Ä‡§∞‡•ç‡§Ø ‡§ï‡§Æ ‡§∂‡•Å‡§ï‡•ç‡§∞‡§æ‡§£‡•Å ‡§∏‡•á ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§",
"details_en":["Frequent ejaculation","Low density","Often reversible"],
"details_hi":["‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞ ‡§∏‡•ç‡§ñ‡§≤‡§®","‡§ï‡§Æ ‡§ò‡§®‡§§‡•ç‡§µ","‡§∏‡•Å‡§ß‡§∞ ‡§∏‡§ï‡§§‡§æ"],
"care_en":["Nutrition","Hydration","Reduce frequency","Test if persistent"],
"care_hi":["‡§™‡•ã‡§∑‡§£","‡§™‡§æ‡§®‡•Ä","‡§Ü‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§ï‡§Æ","‡§ú‡§æ‡§Ç‡§ö"]
},

"vaginal_discharge_odor":{
"summary_en":"Foul vaginal odor often indicates bacterial imbalance.",
"summary_hi":"‡§Ø‡•ã‡§®‡§ø ‡§ï‡•Ä ‡§¶‡•Å‡§∞‡•ç‡§ó‡§Ç‡§ß ‡§¨‡•à‡§ï‡•ç‡§ü‡•Ä‡§∞‡§ø‡§Ø‡§≤ ‡§Ö‡§∏‡§Ç‡§§‡•Å‡§≤‡§® ‡§ï‡§æ ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§π‡•à‡•§",
"details_en":["BV common","pH imbalance","Infection possible"],
"details_hi":["BV ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø","pH ‡§ó‡§°‡§º‡§¨‡§°‡§º‡•Ä","‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§£"],
"care_en":["Hygiene","Cotton underwear","Avoid scented wash","Gynecologist"],
"care_hi":["‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ‡§§‡§æ","‡§ï‡•â‡§ü‡§®","‡§∏‡•Å‡§ó‡§Ç‡§ß‡§ø‡§§ ‡§®","‡§°‡•â‡§ï‡•ç‡§ü‡§∞"]
},

"vaginal_itching":{
"summary_en":"Vaginal itching often due to fungal infection.",
"summary_hi":"‡§Ø‡•ã‡§®‡§ø ‡§ñ‡•Å‡§ú‡§≤‡•Ä ‡§´‡§Ç‡§ó‡§≤ ‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§£ ‡§∏‡•á‡•§",
"details_en":["Candida common","Moisture factor","Irritation"],
"details_hi":["‡§ï‡•à‡§Ç‡§°‡§ø‡§°‡§æ","‡§®‡§Æ‡•Ä","‡§ú‡§≤‡§®"],
"care_en":["Keep dry","Cotton","Avoid tight","Antifungal"],
"care_hi":["‡§∏‡•Ç‡§ñ‡§æ","‡§ï‡•â‡§ü‡§®","‡§¢‡•Ä‡§≤‡•á ‡§ï‡§™‡§°‡§º‡•á","‡§¶‡§µ‡§æ"]
},

"uti":{
"summary_en":"Burning urination due to urinary infection.",
"summary_hi":"‡§™‡•á‡§∂‡§æ‡§¨ ‡§Æ‡•á‡§Ç ‡§ú‡§≤‡§® ‡§Æ‡•Ç‡§§‡•ç‡§∞ ‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§£ ‡§∏‡•á‡•§",
"details_en":["Bacterial infection","Common female","Needs care"],
"details_hi":["‡§¨‡•à‡§ï‡•ç‡§ü‡•Ä‡§∞‡§ø‡§Ø‡§æ","‡§Æ‡§π‡§ø‡§≤‡§æ‡§ì‡§Ç ‡§Æ‡•á‡§Ç","‡§â‡§™‡§ö‡§æ‡§∞"],
"care_en":["Water","Do not hold","Hygiene","Doctor"],
"care_hi":["‡§™‡§æ‡§®‡•Ä","‡§® ‡§∞‡•ã‡§ï‡•á‡§Ç","‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ‡§§‡§æ","‡§°‡•â‡§ï‡•ç‡§ü‡§∞"]
}

}

# ======================
# GENERIC MEDICAL ENGINE
# ======================
def generic_medical_advice(text, lang="en"):
    t=text.lower()
    care_en=[]
    care_hi=[]

    if any(w in t for w in ["infection","viral","bacterial"]):
        care_en+=["Hydration","Hygiene","Medical care if persistent"]
        care_hi+=["‡§™‡§æ‡§®‡•Ä","‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ‡§§‡§æ","‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§∞‡§π‡•á ‡§§‡•ã ‡§°‡•â‡§ï‡•ç‡§ü‡§∞"]

    if any(w in t for w in ["pain","ache"]):
        care_en+=["Rest","Pain relief if needed"]
        care_hi+=["‡§Ü‡§∞‡§æ‡§Æ","‡§¶‡§∞‡•ç‡§¶ ‡§®‡§ø‡§µ‡§æ‡§∞‡§ï"]

    if any(w in t for w in ["inflammation","swelling"]):
        care_en+=["Rest affected area","Anti-inflammatory"]
        care_hi+=["‡§Ü‡§∞‡§æ‡§Æ","‡§∏‡•Ç‡§ú‡§®‡§∞‡•ã‡§ß‡•Ä"]

    if any(w in t for w in ["genetic","syndrome","disorder"]):
        care_en+=["Specialist evaluation","Supportive care"]
        care_hi+=["‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û","‡§∏‡§π‡§æ‡§Ø‡§ï ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤"]

    if not care_en:
        care_en=["Medical evaluation recommended"]
        care_hi=["‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§™‡§∞‡§æ‡§Æ‡§∞‡•ç‡§∂"]

    return care_hi if lang=="hi" else care_en

# ======================
# RETRIEVE
# ======================
def retrieve(q):
    q_en=to_en(q)
    emb=model.encode([q_en])
    sims=cosine_similarity(emb,embeddings)[0]
    return df.iloc[np.argmax(sims)]["answer"]

# ======================
# GENERATE RESPONSE
# ======================
def generate(q):
    L=detect_lang(q)
    cond=detect_condition(q)

    if cond in solutions:
        data=solutions[cond]
        summary=data["summary_hi"] if L=="hi" else data["summary_en"]
        details="\n".join([f"‚Ä¢ {t}" for t in (data["details_hi"] if L=="hi" else data["details_en"])])
        care="\n".join([f"‚Ä¢ {t}" for t in (data["care_hi"] if L=="hi" else data["care_en"])])

        return f"""
ü©∫ {"‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø" if L=="hi" else "Possible condition"}:
{summary}

üìñ {"‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä" if L=="hi" else "Details"}:
{details}

‚úÖ {"‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞‡•á‡§Ç" if L=="hi" else "What you can do"}:
{care}

‚ö†Ô∏è {"‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§¨‡§®‡•Ä ‡§∞‡§π‡•á ‡§§‡•ã ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§Æ‡§ø‡§≤‡•á‡§Ç‡•§" if L=="hi" else "Consult a doctor if persistent."}
"""

    ans=retrieve(q)
    short=re.split(r'(?<=[.!?]) +',ans)[0]
    if L=="hi":
        short=to_hi(short)

    generic=generic_medical_advice(ans,L)
    generic="\n".join([f"‚Ä¢ {t}" for t in generic])

    return f"""
ü©∫ {"‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä" if L=="hi" else "Possible information"}:
{short}

‚úÖ {"‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞‡•á‡§Ç" if L=="hi" else "What you can do"}:
{generic}

‚ö†Ô∏è {"‡§∏‡§π‡•Ä ‡§®‡§ø‡§¶‡§æ‡§® ‡§π‡•á‡§§‡•Å ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§Æ‡§ø‡§≤‡•á‡§Ç‡•§" if L=="hi" else "Consult a doctor for diagnosis."}
"""

# ======================
# UI
# ======================
box=widgets.Text(
    placeholder="Describe symptoms in Hindi or English...",
    description="Query:",
    layout=widgets.Layout(width="80%")
)
out=widgets.Output()

def submit(sender):
    if sender.value.strip():
        with out:
            clear_output()
            print(generate(sender.value))

box.on_submit(submit)
display(box,out)

print("\n‚úÖ BEAST v3 BULLETPROOF Assistant Ready.")

